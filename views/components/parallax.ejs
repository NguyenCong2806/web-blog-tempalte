<% if (typeof parallaxes !== 'undefined' && parallaxes.length > 0) { %>
  <%
     parallaxes.sort((a, b) => (a.location || 999) - (b.location || 999));
  %>
  <% parallaxes.forEach(function(item, index) { %>
    <section 
      class="parallax-section relative w-full h-[300px] md:h-[400px] overflow-hidden flex items-center justify-center my-12"
      data-strength="<%= item.strength || 0.5 %>"
      data-blurmin="<%= item.blurmin || 0 %>"
      data-blurmax="<%= item.blurmax || 0 %>"
    >
      
      <div class="parallax-bg absolute top-[-20%] left-0 w-full h-[140%] -z-10 will-change-transform">
        <img 
          src="<%= item.bgimage || '/images/parallax-default.jpg' %>" 
          alt="<%= item.bgimagealt || 'Background' %>" 
          class="w-full h-full object-cover"
        >
      </div>

      <div class="absolute inset-0 bg-black/20"></div>

      <% if (item.site) { %>
        <div class="relative z-10 p-8 border-4 border-white/30 backdrop-blur-sm rounded-none">
          <h2 class="text-3xl md:text-5xl font-bold text-white uppercase tracking-[0.2em] drop-shadow-lg">
            <%= item.site %>
          </h2>
        </div>
      <% } %>

    </section>

  <% }); %>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const parallaxSections = document.querySelectorAll('.parallax-section');

      // Hàm update vị trí
      const updateParallax = () => {
        parallaxSections.forEach(section => {
          const rect = section.getBoundingClientRect();
          const windowHeight = window.innerHeight;

          // Chỉ tính toán khi section nằm trong vùng nhìn thấy (Viewport)
          if (rect.top < windowHeight && rect.bottom > 0) {
            
            // Tính toán vị trí tương đối (-1 đến 1)
            // 0 là khi section nằm chính giữa màn hình
            const centerPosition = (rect.top + rect.height / 2) - (windowHeight / 2);
            
            // 1. Xử lý di chuyển (TranslateY)
            const strength = parseFloat(section.dataset.strength);
            const bg = section.querySelector('.parallax-bg');
            // Công thức: Di chuyển ngược chiều cuộn chuột
            const translateY = centerPosition * strength;
            
            if (bg) {
              bg.style.transform = `translateY(${translateY}px)`;
            }

            // 2. Xử lý làm mờ (Blur) - Nếu có cấu hình
            const blurMin = parseFloat(section.dataset.blurmin);
            const blurMax = parseFloat(section.dataset.blurmax);
            
            if (blurMax > blurMin) {
              // Tính % cuộn qua section (0 -> 1)
              let progress = 1 - (rect.top / windowHeight);
              progress = Math.max(0, Math.min(1, progress)); // Clamp 0-1
              
              const currentBlur = blurMin + (progress * (blurMax - blurMin));
              const img = section.querySelector('img');
              if (img) {
                img.style.filter = `blur(${currentBlur}px)`;
              }
            }
          }
        });
      };

      // Gắn sự kiện scroll
      window.addEventListener('scroll', () => {
        window.requestAnimationFrame(updateParallax);
      });
      
      // Chạy 1 lần đầu tiên
      updateParallax();
    });
  </script>

<% } %>