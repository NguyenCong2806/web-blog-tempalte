<% if (typeof modalPopups !== 'undefined' && modalPopups.length > 0) { %>

  <% modalPopups.forEach(function(item) { %>
    
    <% 
        // Xá»­ lÃ½ chuá»—i HTML bá»‹ mÃ£ hÃ³a
        let rawHtml = item.note || ""; 
        let decodedHtml = rawHtml
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&amp;/g, '&');
        let finalHtml = decodedHtml.replace(/^<p>|<\/p>$/g, '');
        
        // Táº¡o ID ngáº«u nhiÃªn náº¿u khÃ´ng cÃ³
        let modalId = item._id || Math.random().toString(36).substr(2, 9);
        
        // ðŸ‘‡ Sá»¬A Láº I TÃŠN BIáº¾N CHO KHá»šP DATA (Viáº¿t thÆ°á»ng)
        let pos = item.position || 1;
        let tStart = item.timestart || 0;
        let tEnd = item.timeend || 0;
        let sStart = item.scrollstart || 0;
        let sEnd = item.scrollend || 0;
    %>

    <div class="modal-wrapper hidden fixed z-[9999] inset-0 transition-all duration-300" 
         id="modal-<%= modalId %>"
         data-id="<%= modalId %>"
         data-timestart="<%= tStart %>"
         data-timeend="<%= tEnd %>"
         data-scrollstart="<%= sStart %>"
         data-scrollend="<%= sEnd %>" 
         data-position="<%= pos %>">

        <% if (pos == 1) { %>
            <div class="modal-backdrop absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300 cursor-pointer"></div>
            <div class="flex items-center justify-center min-h-screen px-4 pointer-events-none">
                <div class="modal-content relative w-full max-w-3xl bg-white rounded-xl shadow-2xl scale-90 opacity-0 transition-all duration-300 pointer-events-auto max-h-[90vh] overflow-y-auto">
                    <button class="btn-close absolute top-2 right-2 z-10 w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 rounded-full cursor-pointer transition-colors">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <div class="p-2">
                        <%- finalHtml %>
                    </div>
                </div>
            </div>

        <% } else { %>
            <div class="absolute bottom-4 right-4 w-full max-w-sm pointer-events-none overflow-hidden">
                <div class="modal-content relative bg-white rounded-lg shadow-xl border border-gray-200 translate-y-20 opacity-0 transition-all duration-500 pointer-events-auto">
                    <div class="flex justify-between items-center bg-blue-600 px-4 py-2 rounded-t-lg">
                        <span class="text-white text-xs font-bold uppercase truncate"><%= item.titel || 'ThÃ´ng bÃ¡o' %></span>
                        <button class="btn-close text-white hover:text-red-200 cursor-pointer">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-4 max-h-[60vh] overflow-y-auto">
                        <%- finalHtml %>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

  <% }); %>

  <script>
    // HÃ m helper Ä‘á»ƒ tÃ­nh scroll percentage
    function getScrollPercent() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight;
      const winHeight = window.innerHeight;
      const scrollableHeight = Math.max(docHeight - winHeight, 1);
      return (scrollTop / scrollableHeight) * 100;
    }

    document.addEventListener("DOMContentLoaded", function() {
      const modals = document.querySelectorAll('.modal-wrapper');

      modals.forEach(modal => {
        const id = modal.dataset.id;
        // Láº¥y data vÃ  Ã©p kiá»ƒu sá»‘
        const timeStart = parseInt(modal.dataset.timestart) || 0;
        const timeEnd = parseInt(modal.dataset.timeend) || 0;
        const scrollStart = parseInt(modal.dataset.scrollstart) || 0;
        const scrollEnd = parseInt(modal.dataset.scrollend) || 0;
        const position = parseInt(modal.dataset.position);

        // --- 1. Check Ä‘Ã£ Ä‘Ã³ng chÆ°a ---
        // âš ï¸ Bá» comment dÃ²ng nÃ y Ä‘á»ƒ xÃ³a sessionStorage khi debug:
        // sessionStorage.removeItem(`popup_closed_${id}`);
        
        if (sessionStorage.getItem(`popup_closed_${id}`)) {
          console.log(`Modal ${id} Ä‘Ã£ bá»‹ Ä‘Ã³ng trÆ°á»›c Ä‘Ã³`);
          return;
        }

        // --- 2. Check Thá»i gian ---
        const now = Date.now();
        if (timeStart > 0 && now < timeStart) {
          console.log(`Modal ${id} - ChÆ°a tá»›i thá»i gian hiá»ƒn thá»‹`);
          return;
        }
        if (timeEnd > 0 && now > timeEnd) {
          console.log(`Modal ${id} - ÄÃ£ quÃ¡ thá»i gian hiá»ƒn thá»‹`);
          return;
        }

        console.log(`ðŸŽ¯ Modal ${id} khá»Ÿi táº¡o - ScrollStart: ${scrollStart}%, ScrollEnd: ${scrollEnd}%`);

        // HÃ m Hiá»ƒn thá»‹
        const showModal = () => {
          if (modal.classList.contains('active')) return;
          
          console.log(`âœ… Hiá»ƒn thá»‹ modal ${id}`);
          modal.classList.remove('hidden');
          modal.classList.add('active');

          setTimeout(() => {
            const backdrop = modal.querySelector('.modal-backdrop');
            const content = modal.querySelector('.modal-content');
            
            if (position == 1) {
               if(backdrop) backdrop.classList.remove('opacity-0');
               if(content) {
                   content.classList.remove('scale-90', 'opacity-0');
                   content.classList.add('scale-100', 'opacity-100');
               }
            } else {
               if(content) {
                   content.classList.remove('translate-y-20', 'opacity-0');
                   content.classList.add('translate-y-0', 'opacity-100');
               }
            }
          }, 50);
        };

        // HÃ m áº¨n
        const hideModal = () => {
             if (!modal.classList.contains('active')) return;

             console.log(`âŒ áº¨n modal ${id}`);
             const backdrop = modal.querySelector('.modal-backdrop');
             const content = modal.querySelector('.modal-content');

             if(backdrop) backdrop.classList.add('opacity-0');
             if(content) {
                content.classList.remove('scale-100', 'translate-y-0', 'opacity-100');
                if(position == 1) content.classList.add('scale-90', 'opacity-0');
                else content.classList.add('translate-y-20', 'opacity-0');
             }
             
             setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('active');
             }, 300);
        };

        // HÃ m ÄÃ³ng vÄ©nh viá»…n
        const closeModalForever = () => {
            hideModal();
            sessionStorage.setItem(`popup_closed_${id}`, 'true');
            console.log(`ðŸ”’ Modal ${id} Ä‘Ã£ bá»‹ Ä‘Ã³ng vÄ©nh viá»…n`);
        }

        // --- 3. Logic Trigger ---
        if (scrollStart > 0) {
          // Trigger theo cuá»™n chuá»™t
          let scrollTimeout;
          
          const checkScroll = () => {
             if (sessionStorage.getItem(`popup_closed_${id}`)) return;

             const scrollPercent = getScrollPercent();
             console.log(`Modal ${id} - Scroll hiá»‡n táº¡i: ${scrollPercent.toFixed(2)}% (Range: ${scrollStart}% - ${scrollEnd}%)`);

             // Logic Scroll Start & End
             if (scrollPercent >= scrollStart && scrollPercent <= scrollEnd) {
                 showModal();
             } else {
                 hideModal();
             }
          };

          // âœ… QUAN TRá»ŒNG: Check ngay khi load (khÃ´ng chá» scroll)
          checkScroll();

          // ThÃªm event listener vá»›i throttle
          window.addEventListener('scroll', () => {
             clearTimeout(scrollTimeout);
             scrollTimeout = setTimeout(checkScroll, 100);
          });
        } else {
          // Hiá»‡n ngay láº­p tá»©c (Delay 1.5s)
          console.log(`Modal ${id} - Hiá»‡n ngay vá»›i delay 1.5s`);
          setTimeout(showModal, 1500);
        }

        // --- 4. Sá»± kiá»‡n click Ä‘Ã³ng ---
        const closeBtns = modal.querySelectorAll('.btn-close, .modal-backdrop');
        closeBtns.forEach(btn => {
           btn.addEventListener('click', closeModalForever);
        });

      });
    });
  </script>
<% } %>